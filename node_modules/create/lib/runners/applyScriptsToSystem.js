import { groupBy } from "../utils/groupBy.js";
export async function applyScriptsToSystem(scripts, system) {
    const scriptsByPhase = groupBy(scripts.filter((script) => typeof script === "object"), (script) => script.phase ?? Infinity);
    const commandsStandalone = scripts.filter((script) => typeof script === "string");
    const phaseKeys = Object.keys(scriptsByPhase)
        .map((key) => Number(key))
        .sort();
    async function runCommand(command, silent) {
        system.display.item("script", command, { start: Date.now() });
        const result = await system.runner(command);
        system.display.item("script", command, { end: Date.now() });
        if (result instanceof Error && !silent) {
            system.display.item("script", command, { error: result });
        }
    }
    const commandsStandaloneTask = Promise.all(commandsStandalone.map(async (command) => {
        await runCommand(command);
    }));
    for (const phase of phaseKeys) {
        await Promise.all(scriptsByPhase[phase].map(async (script) => {
            for (const command of script.commands) {
                await runCommand(command, script.silent);
            }
        }));
    }
    await commandsStandaloneTask;
}
//# sourceMappingURL=applyScriptsToSystem.js.map